name: Check Build

on:
  pull_request:
    branches: [ master ]

jobs:
  jsBuild:
    runs-on: ubuntu-20.04
    concurrency:
      group: ${{ github.ref }}_jsBuild
      cancel-in-progress: true
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Gradle cache
        uses: gradle/gradle-build-action@v2
      - name: KMP cache
        uses: actions/cache@v2
        id: konan-js-build
        with:
          path: '~/.konan/**'
          key: konan-js-build
      - name: Compile Javascript app
        run: set -o pipefail && bash ./deploy/build.sh functions
      - name: Save artifacts
        uses: actions/upload-artifact@v3
        with:
          name: Javascript build
          path: |
            functions/*.js
            functions/*.json

  jsTest2:
    runs-on: ubuntu-20.04
    concurrency:
      group: ${{ github.ref }}_jsTest
      cancel-in-progress: true
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Gradle cache
        uses: gradle/gradle-build-action@v2
      - name: KMP cache
        uses: actions/cache@v2
        id: konan-js-test
        with:
          path: '~/.konan/**'
          key: konan-js-test
      - name: Javascript tests
        run: set -o pipefail && ./gradlew --continue test
      # Always run this job even if the previous steps fail to collect all test reports
      - name: Generate Javascript test report
        uses: mikepenz/action-junit-report@v3
        if: always()
        with:
          report_paths: 'appJs/**/build/test-results/nodeTest/TEST-*.xml'
          check_name: 'kmpTestResults'
      # Always run this job even if the previous steps fail to collect all artifacts
      - name: Save artifacts
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: Javascript test results
          path: 'appJs/**/build/test-results/nodeTest/TEST-*.xml'